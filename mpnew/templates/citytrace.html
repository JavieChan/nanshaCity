## citytrace.html
<%inherit file="base.html" />
<div class="wrapper phase2">
	<!--导航-->
	<%include file="nav.html" args="on={'citytrace': 'on'}"/>
	<!--右侧功能栏-->
	<div class="projects">
		<div class="tabbox">
			<div class="bread">
				<h2>
					<a href="#">所有项目</a>
					&gt; <span style="color:#333">城市感知网</span>
					&gt; <span style="color:#0faee5">城市寻迹</span>
				</h2>
			</div>
		</div>
		<div class="tabbox">
			<div class="toolnav">
				<div class="date-box">
					<input type="text" id="dateStart" placeholder="选择开始时间"> -
					<input type="text" id="dateEnd" placeholder="选择结束时间"> &nbsp; &nbsp;
					<input type="text" class="txt-mac" placeholder="搜索设备Mac地址（格式：FC:57:B6:2C:B6:2C）" maxlength="17" />
					<button class="btnBlueSmall btn-search" style="width: auto; ">　搜索　</button>
					<span class="loading-txt">
						<img src="data:image/gif;base64,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" alt="" />
						正在查询...
					</span>
				</div>
			</div>
		</div>
		<div class="map-box">
			<div id="citymap"></div>
			<div class="map-pop">
				<div class="close"><span>×</span></div>
				<div class="ctt">×</div>
			</div>
		</div>

		<div class="tabbox " id="">
			<div class="toolnav">
				<span class="cur-mac-span">【设备MAC地址】<span class='cur-mac'>FC:57:B6:2C</span></span>
				<div class="toolbox batch">
					<a class="link-excel" href="javascript:;" target="_blank">正在导出...</a>
					<button class="btnBlueSmall btn-excel dis" disabled="disabled">整表导出为Excel</button>
				</div>
			</div>
			<div class="sort-panel">
				<div class="client-table-box">
					<table class="client-table">
						<tr class="th">
							<td>日期</td>
							<td>AP名称</td>
							<td>AP位置</td>
							<td>出现时间</td>
							<td>消失时间</td>
							<td>停留时长</td>
							<td>信号强度</td>
						</tr>
						<tr class="loading-tr">
							<td colspan="7">&nbsp;</td>
						</tr>
					</table>
					<div class="page-box">
						共<span class="page-total">1</span>页 &nbsp;&nbsp; 当前第
						<span class="page-now">1</span>页 &nbsp;&nbsp;
						<a class="page-pre" href="javascript:;">上一页</a>
						&nbsp;&nbsp;
						<a class="page-next" href="javascript:;">下一页</a>
						&nbsp;&nbsp; 到第
						<input type="text" class="page-num" />页
						<button class="button-jump">Go</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<%block name="jscode">

		<script type="text/javascript" src="../static/js/2qi.js"></script>
		<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=38be3b6a4b58f6632251b88809db0b82&&plugin=AMap.Scale,AMap.ToolBar,AMap.Geocoder,AMap.MarkerClusterer"></script>
		<script type="text/javascript" src="../static/js/lib/jqueryui.min.js"></script>
		<script type="text/javascript" src="../static/js/lib/jquery-ui-timepicker-addon.js"></script>
		<script>
			$(function() {
				//var macArr = ['00:00:00:03:79:7E','00:0C:E7:87:2D:92']
				var macI = 0;
				var getParams = function() {
					//$(".txt-mac").val(macArr[macI]);
					macI += 1;
					var ap = $(".txt-mac").val(),
						start_time = $("#dateStart").val(),
						end_time = $("#dateEnd").val();

					if(ap == "" || ap == null) {
						alert("请输入MAC地址");
						return;
					}
					if(start_time == "" || end_time == "") {
						alert("请选择统计时间范围");
						return;
					}
					if(start_time > end_time) {
						alert("统计时间范围有误，请检查");
						return;
					}

					start_time = start_time.replace(/(\s+)|(-)|(:00)/g, ""); //2017-06-20 08:00转换成2017062008
					end_time = end_time.replace(/(\s+)|(-)|(:00)/g, "");

					var params = {
						client_mac: ap,
						start_t: parseInt(start_time),
						end_t: parseInt(end_time),
					}
					return params;
				}

				var pageNum = 1,
					pageSize = 30,
					totalPage = 1;

				var showTableData = function(data) {				
					if(data.Code.Code == 200) {
						var apList = data["ap_list"];
						if(typeof(apList) == "undefined") {
							$(".loading-txt").hide();
							alert("暂无数据。")
							return;
						}
						if(apList.length < 1) {
							alert("暂无数据。");
						} else {
							$(".loading-txt").hide();
							$(".btn-excel").attr("disabled",false).removeClass("dis");

							//拼表格数据
							var str = "";
							for(var i = 0; i < apList.length; i++) {
								str += "<tr><td>" + apList[i].day;
								str += "</td><td>" + apList[i].ap_name;
								str += "</td><td>" + apList[i].ap_addr;
								str += "</td><td>" + apList[i].show_time;
								str += "</td><td>" + apList[i].leave_time;
								str += "</td><td>" + apList[i].stay;
								str += "</td><td>" + apList[i].rssi;
								str += "</td></tr>"
							}
							$(".loading-tr").hide();
							//$(".client-table").append(str);
							$(".client-table tr:not(.th,.loading-tr)").remove();
							$(str).insertAfter(".client-table tr.th");

							if(typeof(data.total_num) == "undefined") {
								return
							}
							totalPage = Math.ceil(data.total_num / pageSize);
							$(".page-total").html(totalPage);
							$(".page-now").html(pageNum);
							$(".page-pre,.page-next").removeClass("dis");
							if(pageNum == 1) {
								$(".page-pre").addClass("dis");
							}
							if(pageNum == totalPage) {
								$(".page-next").addClass("dis");
							}
							$(".page-box").show();
						}
					}
				}
				
				//导出excel
				var downExcelGroup = function() {
					var params = curListParams;
					if(params == null) {
						alert("暂无数据。")
						return;
					}
					delete params.page_num;
					delete params.page_size;
					
					$(".btn-excel").attr("disabled",true).addClass("dis");
					$(".link-excel").show().html("正在导出...");
					$.ajax({
						url: ajaxDomain + ajaxUrls.xlsCityTrace,
						type: "post",
						data: JSON.stringify(params),
						contentType: "application/json",
						success: function(data) {							
							$(".btn-excel").attr("disabled",false).removeClass("dis");
							if(typeof(data.dataurl)=="undefined"){
								$(".link-excel").hide();
								alert("暂无数据。");
								return;
							}
							//window.open(data.dataurl);
							$(".link-excel").attr("href",data.dataurl).html("点击下载");
						},
						error: function() {
							$(".link-excel").hide();
							$(".btn-excel").attr("disabled",false).removeClass("dis");
							
							console.warn("ajax error：");
							console.log(arguments);
						}
					});
				}
				
				$(document).on("click", ".btn-excel", function() {
					downExcelGroup();
				})
				
				var curListParams=null;
				var traceAjax = function(params){
					$(".loading-txt").show();
					$(".cur-mac").html(params.client_mac);
					$(".cur-mac-span").show();
					$.ajax({
						url: ajaxDomain + ajaxUrls.clientTrace,
						type: "post",
						data: JSON.stringify(params),
						contentType: "application/json",
						success: function(data) {
							if(typeof(params.page_size)!="undefined"){
								curListParams = params;
								showTableData(data);
								return;
							}							
							if(data.Code.Code == 200) {
								var apList = data["ap_list"];
								if(typeof(apList) == "undefined") {
									$(".loading-txt").hide();
									alert("暂无数据。")
									return;
								}
								if(apList.length < 1) {
									alert("暂无数据。");
								} else {
									showMapData(apList);
									$(".loading-txt").hide();
									//获取表格数据（分页）
									pageNum=1;
									params.page_num = pageNum;
									params.page_size = pageSize;									
									$(".btn-excel").attr("disabled",true).addClass("dis");									
									$(".link-excel").hide();
									traceAjax(params);
								}
							}
						}
					})						
				}
				var getClientTrace = function(all) {
					var params = getParams();
					if(typeof(params) == "undefined") {
						return;
					}
					if(typeof(all) == "undefined") {						
						params.page_size = pageSize;
						params.page_num = pageNum;
					}					
					traceAjax(params);
				}
				$(document).on("click", ".btn-search", function() {
					getClientTrace("all");
				})				

				var myMap;
				var pileLng = 0,
					pileLat = 0;
				var cluster, markers = null,
					lineMakers = null;;
				var pointMark = null,
					infoWindow = null,
					zoomN;

				function initMap() {
					var scale = new AMap.Scale(),
						toolBar = new AMap.ToolBar();
					myMap = new AMap.Map('citymap', {
						resizeEnable: true,
						zoom: 10,
						center: [113.513364, 22.732559], //南沙区域正中心点	//[113.53141,22.808029],//南沙区政府点
					});

					myMap.addControl(scale);
					myMap.addControl(toolBar);
					infoWindow = new AMap.InfoWindow({
						offset: new AMap.Pixel(0, -30)
					});
				}
				initMap();

				myMap.on("zoomchange", function() {
					var zoomLV = myMap.getZoom();
					$(".mark-jt").css({
						width: zoomLV * zoomLV / 10 + "px",
						height: zoomLV * zoomLV / 10 + "px"
					})
					//					if(zoomLV){
					//						mark-jt
					//					}
				})

				function showMapData(apList) {
					myMap.clearMap(); // 清除地图覆盖物
					$(".map-pop").fadeOut(300);

					//
					//					if(markers) {
					//						for(var i = 0; i < markers.length; i++) {
					//							markers[i].hide();
					//						}
					//					}
					//					if(cluster) {
					//						cluster.setMap(null);
					//					}
					//					if(pointMark) {
					//						pointMark.hide();
					//					}
					//infoWindow.close();

					markers = [];
					lineMakers = [];

					//将数据按时间（日期+出现+离开）进行排序
					var apData = JSON.parse(JSON.stringify(apList));
					for(var i = apData.length - 1; i >= 0; i--) {
						var lngI = apData[i].lng,
							latI = apData[i].lat;
						if(typeof(lngI) == "undefined" || typeof(latI) == "undefined" || lngI == "" || latI == "") {
							apData.splice(i, 1);
							continue;
						}
						apData[i].dateTime = apData[i].day + "-" + apData[i].show_time + "-" + apData[i].leave_time;
					}
					apData.sort(sortBy('dateTime', true, String));

					var sameLineArr = [],
						sameLineNum = [],
						traceIdx = 0;

					for(var i = 1; i < apData.length; i++) {
						//前后两点坐标不同时，画连线
						if((apData[i].lng + ',' + apData[i].lat) != (apData[i - 1].lng + ',' + apData[i - 1].lat)) {

							var x1 = apData[i - 1].lng,
								y1 = apData[i - 1].lat,
								x2 = apData[i].lng,
								y2 = apData[i].lat;
							//画线
							var pltest = new AMap.Polyline({
								path: [
									[x1, y1],
									[x2, y2]
								], //设置线覆盖物路径
								strokeColor: "#36f", //线颜色
								strokeOpacity: 1, //线透明度
								strokeWeight: 2, //线宽
								strokeStyle: "solid", //线样式
							});
							pltest.setMap(myMap);

							//计算线条、箭头的角度（没找到高德设置线条箭头的api）
							var l_jiaodu = Math.atan((y2 - y1) / (x2 - x1));
							if(x2 < x1 && y2 >= y1) l_jiaodu = Math.PI + l_jiaodu;
							if(x2 < x1 && y2 < y1) l_jiaodu = l_jiaodu - Math.PI;
							//画箭头（用一个div两条直角边，css3旋转）
							var deg = 135 - l_jiaodu * 180 / Math.PI;
							var marker = new AMap.Marker({ //添加自定义点标记
								map: myMap,
								position: [x2, y2],
								offset: new AMap.Pixel(0, 0), //相对于基点的偏移位置
								content: '<i class="mark-jt" style="transform:rotate(' + deg + 'deg);border-color:#36f;"></i>' //自定义点标记覆盖物内容
							});

							traceIdx++;
							var lineLabelCtt = '<i>' + traceIdx + '</i>';

							var xy1xy2 = x1 + "-" + y1 + "-" + x2 + "-" + y2,
								xy2xy1 = x2 + "-" + y2 + "-" + x1 + "-" + y1;
							if(sameLineArr.indexOf(xy1xy2) < 0 && sameLineArr.indexOf(xy2xy1) < 0) {
								sameLineArr.push(xy1xy2);
								sameLineNum.push(lineLabelCtt);
							} else {
								if(sameLineArr.indexOf(xy1xy2) >= 0) {
									sameLineNum[sameLineArr.indexOf(xy1xy2)] += lineLabelCtt;
								} else {
									sameLineNum[sameLineArr.indexOf(xy2xy1)] += lineLabelCtt;
								}
							}

						}
					}
					//					console.log(sameLineArr)
					//					console.log(sameLineNum)
					for(var i = 0; i < sameLineArr.length; i++) {
						var ll = sameLineArr[i].split("-");
						var lng1 = parseFloat(ll[0]) + parseFloat(ll[2]),
							lat1 = parseFloat(ll[1]) + parseFloat(ll[3]);
						var lineLabel = new AMap.Marker({ //添加自定义点标记
							map: myMap,
							position: [lng1 / 2, lat1 / 2],
							offset: new AMap.Pixel(0, 0), //相对于基点的偏移位置
							content: '<div class="mark-line">' + sameLineNum[i] + '</div>' //自定义点标记覆盖物内容
						});
					}

					//画点
					var samePArr = [],
						conStrArr = [];

					function setInfoWindowCtt(marker, i) {
						marker.content = conStrArr[i];
						marker.on('mouseover', markerClick);
					}
					for(var i = 0; i < apData.length; i++) {
						var object = apData[i];

						var thisLnglat = object.lng + ',' + object.lat;
						var conStr = '<div class="marker-info-line"><label>AP：</label>' + object.ap_name;
						//conStr += '<br><label>MAC：</label>' + object.ap_mac;
						conStr += '<br><label>位置：</label>' + object.address + " - " + object.ap_addr;
						conStr += '<br><label>时间：</label>' + object.day + ' ' + object.show_time + '-' + object.leave_time + "</div>";

						if(samePArr.indexOf(thisLnglat) > -1) {
							if(object.day != apData[i - 1].day) {
								conStr = conStr.replace("marker-info-line", "marker-info-line not-same-day");
							}
							conStrArr[samePArr.indexOf(thisLnglat)] += conStr;
						} else {
							samePArr.push(thisLnglat)
							conStrArr.push(conStr)
							var marker = new AMap.Marker({ //添加自定义点标记
								map: myMap,
								position: [object.lng, object.lat],
								offset: new AMap.Pixel(-8, -8), //相对于基点的偏移位置
								content: '<div class="marker-ap-trace"></div>' //自定义点标记覆盖物内容
							});
							markers.push(marker);
						}
						//						setInfoWindowCtt(marker,i);
					}

					for(var i = 0; i < markers.length; i++) {
						markers[i].content = '<div class="marker-info-box">' + conStrArr[i] + '</div>';
						markers[i].on('mouseover', markerOver);
					}
					myMap.setFitView();
				}

				function markerOver(e) {
					mouseOnFlag = false;
					$(".map-pop .ctt").html(e.target.content);
					$(".map-pop").fadeIn(300);
				}
				$(document).on("click", ".map-pop .close span", function() {
					$(".map-pop").fadeOut(300);
				})

				function markerClick(e) {
					console.log(e.target.content)
					infoWindow.setContent(e.target.content);
					infoWindow.open(myMap, e.target.getPosition());
				}

				function lineOver(e) {
					infoWindow.setContent(e.target.content);
					console.log(e.target.getOptions())
					//					infoWindow.open(myMap, e.target.getPosition());
				}
				//点聚合
				function addCluster() {
					cluster = new AMap.MarkerClusterer(myMap, markers, {
						maxZoom: 16
					});
				}


				$(".page-pre").click(function() {
					if(pageNum == 1) {
						return
					}
					pageNum--;
					getClientTrace();
				});
				$(".page-next").click(function() {
					if(pageNum == totalPage) {
						return
					}
					pageNum++;
					getClientTrace();
				});
				$(".button-jump").click(function() {
					var pg = parseInt($(".page-num").val());
					if(pg > totalPage || pg < 1) {
						return
					}
					getClientTrace();
				});
				
				
				$("#dateStart").datetimepicker({
					dateFormat: 'yy-mm-dd',
					stepMinute: 60,
					onClose: function(selectedDate) {
						$("#dateEnd").datetimepicker("option", "minDate", selectedDate);
					}
				});
				$("#dateEnd").datetimepicker({
					dateFormat: 'yy-mm-dd',
					stepMinute: 60,
					onClose: function(selectedDate) {
						$("#dateStart").datetimepicker("option", "maxDate", selectedDate);
					}
				});
				
				//获取url参数（从区域热力趋势跳转过来）
				var urlMac = $.getUrlParam("ap"),
					urlSt = $.getUrlParam("st"),
					urlEt = $.getUrlParam("et");
				if(urlMac != null && urlSt != null && urlEt != null) {
					var urlParam = [urlMac, urlSt, urlEt];					
					$(".txt-mac").val(urlMac);
					$("#dateStart").val(urlSt.substr(0, 4) + "-" + urlSt.substr(4, 2) + "-" + urlSt.substr(6, 2) + " " + urlSt.substr(8, 2) + ":00");
					$("#dateEnd").val(urlEt.substr(0, 4) + "-" + urlEt.substr(4, 2) + "-" + urlEt.substr(6, 2) + " " + urlEt.substr(8, 2) + ":00");
					getClientTrace("all");
				}else{
					$("#dateStart").datetimepicker("setDate", new Date(new Date().getTime() - 1000 * 60 * 60 * 24));
					$("#dateEnd").datetimepicker("setDate", new Date());					
				}

				//地图弹窗定时关闭				
				//				var mouseOnFlag=false;				
				//				$(document).on("mouseover",".map-pop",function(){
				//					mouseOnFlag=true;
				//				})
				//				$(document).on("mouseout",".map-pop",function(){
				//					mouseOnFlag=false;
				//					setTimeout(function(){
				//						if(!mouseOnFlag){$(".map-pop").fadeOut(300);}
				//					},2000)
				//				})
			})

		</script>

</%block>