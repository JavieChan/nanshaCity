<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title>分布式认证系统（二期）</title>
		<link rel="stylesheet" href="../static/css/jqueryui.css" />
		<link rel="stylesheet" href="../static/css/main.css" />
		<link rel="stylesheet" href="../static/css/2qi.css" />
		<style type="text/css">
			.sort-panel,
			.search-echart-box {
				overflow: hidden;
				width: 880px;
				margin: 0 auto;
			}
			
			.toolnav h3 {
				width: 400px;
				border-left: 3px solid #39f;
				text-indent: 0.5em;
			}
			
			.sort-list-box{
				
			}

			
			#trendChart {
				min-height: 300px;
				min-width: 400px;
			}
			

			.client-table tr.th,.client-table tr.th:hover {
				background-color: #D2F0FF;
			}
			
			.client-table td {
				border: 1px solid #ccc;
				padding: 5px 10px;
				padding: 5px 10px;
			}
			
			.client-table tr:nth-child(2n) {
				background-color: #f2f2f2;
			}
			.client-table tr:hover {
				background: #ffd;
			}
			
			
			
			.duration {
				font-size: 12px;
				line-height: 30px;
				vertical-align: middle;
			}
			
			.duration span {
				display: inline-block;
				width: 30px;
				height: 30px;
				border: 1px solid #ccc;
				border-radius: 100%;
				overflow: hidden;
				text-align: center;
				cursor: pointer;
			}
			
			.duration span.on {
				background: #08c3e5;
				color: #fff;
			}
			
			.duration span.label {
				border: 1px solid transparent;
				cursor: text;
			}
			
			.trend-form>div {
				margin-top: 15px;
			}
			
			.trend-form>div>label {
				margin-right: 6px;
			}
			
			.page-box{
				text-align: right;
				font-size: 13px;
				color: #666;
				display: none;
			}
			.page-pre,.page-next{
				color: #333;
			}
			.page-pre.dis,.page-next.dis{
				color: #999;
				cursor: not-allowed;
			}
			.page-num{
				width: 40px;
			}
			.button-jump{
				width: 24px;
				height: 24px;
				cursor: pointer;
			}
			
			.btn-excel{
				width: 120px;
			}
			.btn-search{
				width: 40px;
			}
			
		</style>
	</head>

	<body>
		<div class="header">
			<div class="wrapper">
				<a href="/index.html" title="分布式认证系统" class="logo">分布式认证系统</a>
				<div class="admin">
					<img src="../static/images/logo_bidong.png" />
					<span class="username">liwenwen</span>
					<span class="cutofline"><i></i></span>
					<a href="/logout" class="logout">退出</a>
				</div>
				<div class="search">
					<input type="text" />
					<button><i class="searchIco"></i></button>
				</div>
			</div>
		</div>
		<div class="content">

			<div class="wrapper">
				<!--导航-->

				<div class="nav">
					<h3 class=""><a href="#"><i class="navProjectIco"></i>AP管理</a></h3>
					<h3 class=""><a href="#"><i class="navPolicyIco"></i>数据分析平台</a></h3>
					<h4 class=""><a href="keywords.html">关键词分析</a></h4>
					<h4 class=""><a href="terminal.html">终端分析</a></h4>
					<h4 class=""><a href="website.html">网站分析</a></h4>
					<h4 class=""><a href="userhx.html">人群画像</a></h4>
					<h3 class=""><a href="#"><i class="navPolicyIco"></i>城市感知网</a></h3>
					<h4 class=""><a href="citymap.html">城市热力图</a></h4>
					<h4 class="on"><a href="trend.html">区域热力趋势</a></h4>
					<h4 class=""><a href="citytrace.html">城市寻迹</a></h4>
					<h4 class=""><a href="supervise.html">AP感知预警</a></h4>
				</div>

				<!--右侧功能栏-->
				<div class="projects">
					<div class="tabbox">
						<div class="bread">
							<h2>
								<a href="#">所有项目</a>
								&gt; <span style="color:#333">城市感知网</span>
								&gt; <span style="color:#0faee5">区域热力趋势</span>
							</h2>
						</div>
					</div>
					<div class="tabbox " id="">
						<div class="toolnav">
							<h3 style="float: none;">热力趋势</h3>
							<div class="trend-form">
								<div>
									<label for="">区域或AP组</label>
									<select name="" class="select-dis-group">
										<!--<option value=""></option>-->
									</select>
									&nbsp; &nbsp; &nbsp;
									<label for="">AP</label>
									<select name="" class="select-ap-list">
										<!--<option value=""></option>-->
									</select>
								</div>
								<div>
									<label for="">统计范围</label>
									<input type="text" id="dateStart" placeholder="选择开始时间"> -
									<input type="text" id="dateEnd" placeholder="选择结束时间">
									<button class="btnBlueSmall chaxun">查询统计</button>
								</div>
							</div>
						</div>
						<div class="toolnav">
							<span class="dis-ap-box"></span>

							<div class="toolbox duration">
								<span class="label">统计维度</span>
								<span class="time-flag on">时</span>
								<span class="time-flag">天</span>
							</div>
						</div>

						<div id="trendChart" class="search-echart-box">
							<!--曲线图-->
						</div>
					</div>

					<div class="tabbox " id="">
						<div class="toolnav">
							<h3>感知到的设备</h3>
							<div class="toolbox batch">
								<button class="btnBlueSmall btn-excel">整表导出为Excel</button>
								&nbsp;&nbsp;
								<input type="text" class="txt-mac" placeholder="MAC地址(FC:57:B6:2C:B6:2C)" maxlength="17"><button class="btnBlueSmall btn-search">搜索</button>
							</div>
						</div>
						<!--<div class="content-title"></div>-->
						<div class="sort-panel">
							<div class="sort-list-box">
								<table class="client-table">
									<tr class="th">
										<td>Mac地址</td>
										<td>姓名</td>
										<td>手机号</td>
										<td>停留时长</td>
										<td>信号强度</td>
										<td>操作</td>
									</tr>
									<tr class="loading-tr"><td colspan="6">&nbsp;</td></tr>
								</table>
								<div class="page-box">
									共<span class="page-total">1</span>页
									&nbsp;&nbsp;
									当前第<span class="page-now">1</span>页
									&nbsp;&nbsp;
									<a class="page-pre" href="javascript:;">上一页</a>
									&nbsp;&nbsp;
									<a class="page-next" href="javascript:;">下一页</a>
									&nbsp;&nbsp;
									到第<input type="text" class="page-num" />页
									<button class="button-jump">Go</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="footer">
			<div class="wrapper">
				<p>广州中国科学院计算机网络信息中心</p>
				<p>电话：020-22992549<span></span>邮箱：gd-xub@chinaunicom.cn</p>
			</div>
		</div>

		<div class="modal fade" id="modalPn">
			<div class="modal_pn modal_body">
				<h3>新增网络配置</h3>
				<p class="notice"><em>注：</em>同一个专网只能有唯一的SSID</p>
				<ul class="vertical">
					<li>
						<label><i>*</i>私有网络：</label>
						<span class="veright">
                    <select id="pri">
                        <option value="0">否</option>
                        <option value="1">是</option>
                    </select>
                </span>
					</li>
					<li>
						<label><i>*</i>收费方式：</label>
						<span class="veright">
                    <select id="policy">
                        <option value="0">收费</option>
                        <option value="1">免费</option>
                    </select>
                </span>
					</li>
					<!--policy 第8位-->
					<li>
						<label><i>*</i>账户认证：</label>
						<span class="veright">
                    <select id="accountRZ">
                        <option value="1">启用</option>
                        <option value="0">停用</option>
                    </select>
                </span>
					</li>
					<!--policy 第9位-->
					<li>
						<label><i>*</i>微信认证：</label>
						<span class="veright">
                    <select id="wechatRZ">
                        <option value="1">启用</option>
                        <option value="0">停用</option>
                    </select>
                </span>
					</li>
					<!--policy 第10位-->
					<li>
						<label><i>*</i>手机号认证：</label>
						<span class="veright">
                    <select id="mobileRZ">
                        <option value="1">启用</option>
                        <option value="0">停用</option>
                    </select>
                </span>
					</li>
					<li>
						<label><i>*</i>SSID：</label>
						<span class="veright"><div class="verify"><input type="text" class="matchVerify shouldVerify" name="ssid" /></div></span>
					</li>
					<li>
						<label>备注：</label>
						<span class="veright"><div class="verify"><input type="text" name="note" /></div></span>
					</li>
					<li class="portalRZ">
						<label><i>*</i>Portal：</label>
						<span class="veright"><div class="verify"><input type="text" class="matchVerify shouldVerify" id="portal" /></div></span>
					</li>
					<li>
						<label>AppId：</label>
						<span class="veright"><div class="verify"><input type="text" name="appid" /></div></span>
					</li>
					<li>
						<label>ShopId：</label>
						<span class="veright"><div class="verify"><input type="text" name="shopid" /></div></span>
					</li>
					<li>
						<label>Secret：</label>
						<span class="veright"><div class="verify"><input type="text" name="secret" /></div></span>
					</li>
					<li class="durationRZ">
						<label><i>*</i>免认证(天)：</label>
						<span class="veright"><div class="verify"><input type="text" name="duration" placeholder="输入天数，例如：5" class="matchVerify shouldVerify checkInt" /></div></span>
					</li>
					<li>
						<label>会话过期时间(小时)：</label>
						<span class="veright"><div class="verify"><input type="text" name="stout" placeholder="输入小时，默认24小时" class="matchVerify checkInt" /></div></span>
					</li>
				</ul>
				<div class="btngroups"><button type="button" class="btnBlue add">确定</button></div>
				<i class="msg"></i>
				<span class="closed">X</span>
				<input type="hidden" name="id" />
				<input type="hidden" name="idx" />
			</div>
		</div>

		<div class="uptotop"><i></i>返回顶部</div>

		<script type="text/javascript" src="../static/js/lib/jquery.min.js"></script>
		<script type="text/javascript" src="../static/js/2qi.js"></script>
		<script type="text/javascript" src="../static/js/echarts.js"></script>
		<script type="text/javascript" src="../static/js/lib/jqueryui.min.js"></script>
		<script type="text/javascript" src="../static/js/lib/jquery-ui-timepicker-addon.js"></script>
		<script>
			//	disGroupList:"sense/disGroupList",//区域或AP组list，返回六镇二街，名称代码列表
			//	getGroupAP:"sense/getGroupAP",//根据区域或者AP组代码返回,AP 列表
			//	disGroupSta:"sense/disGroupSta",//AP 组（区域）统计数值
			//	clientlist:"sense/Clientlist",//感知设备列表
			var loadingImg = '<img src="data:image/gif;base64,R0lGODlhEAAQAMQAAP///+7u7t3d3bu7u6qqqpmZmYiIiHd3d2ZmZlVVVURERDMzMyIiIhEREQARAAAAAP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQFBwAQACwAAAAAEAAQAAAFdyAkQgGJJOWoQgIjBM8jkKsoPEzgyMGsCjPDw7ADpkQBxRDmSCRetpRA6Rj4kFBkgLC4IlUGhbNQIwXOYYWCXDufzYPDMaoKGBoKb886OjAKdgZAAgQkfCwzAgsDBAUCgl8jAQkHEAVkAoA1AgczlyIDczUDA2UhACH5BAUHABAALAAAAAAPABAAAAVjICSO0IGIATkqIiMKDaGKC8Q49jPMYsE0hQdrlABCGgvT45FKiRKQhWA0mPKGPAgBcTjsspBCAoH4gl+FmXNEUEBVAYHToJAVZK/XWoQQDAgBZioHaX8igigFKYYQVlkCjiMhACH5BAUHABAALAAAAAAQAA8AAAVgICSOUGGQqIiIChMESyo6CdQGdRqUENESI8FAdFgAFwqDISYwPB4CVSMnEhSej+FogNhtHyfRQFmIol5owmEta/fcKITB6y4choMBmk7yGgSAEAJ8JAVDgQFmKUCCZnwhACH5BAUHABAALAAAAAAQABAAAAViICSOYkGe4hFAiSImAwotB+si6Co2QxvjAYHIgBAqDoWCK2Bq6A40iA4yYMggNZKwGFgVCAQZotFwwJIF4QnxaC9IsZNgLtAJDKbraJCGzPVSIgEDXVNXA0JdgH6ChoCKKCEAIfkEBQcAEAAsAAAAABAADgAABUkgJI7QcZComIjPw6bs2kINLB5uW9Bo0gyQx8LkKgVHiccKVdyRlqjFSAApOKOtR810StVeU9RAmLqOxi0qRG3LptikAVQEh4UAACH5BAUHABAALAAAAAAQABAAAAVxICSO0DCQKBQQonGIh5AGB2sYkMHIqYAIN0EDRxoQZIaC6bAoMRSiwMAwCIwCggRkwRMJWKSAomBVCc5lUiGRUBjO6FSBwWggwijBooDCdiFfIlBRAlYBZQ0PWRANaSkED1oQYHgjDA8nM3kPfCmejiEAIfkEBQcAEAAsAAAAABAAEAAABWAgJI6QIJCoOIhFwabsSbiFAotGMEMKgZoB3cBUQIgURpFgmEI0EqjACYXwiYJBGAGBgGIDWsVicbiNEgSsGbKCIMCwA4IBCRgXt8bDACkvYQF6U1OADg8mDlaACQtwJCEAIfkEBQcAEAAsAAABABAADwAABV4gJEKCOAwiMa4Q2qIDwq4wiriBmItCCREHUsIwCgh2q8MiyEKODK7ZbHCoqqSjWGKI1d2kRp+RAWGyHg+DQUEmKliGx4HBKECIMwG61AgssAQPKA19EAxRKz4QCVIhACH5BAUHABAALAAAAAAQABAAAAVjICSOUBCQqHhCgiAOKyqcLVvEZOC2geGiK5NpQBAZCilgAYFMogo/J0lgqEpHgoO2+GIMUL6p4vFojhQNg8rxWLgYBQJCASkwEKLC17hYFJtRIwwBfRAJDk4ObwsidEkrWkkhACH5BAUHABAALAAAAQAQAA8AAAVcICSOUGAGAqmKpjis6vmuqSrUxQyPhDEEtpUOgmgYETCCcrB4OBWwQsGHEhQatVFhB/mNAojFVsQgBhgKpSHRTRxEhGwhoRg0CCXYAkKHHPZCZRAKUERZMAYGMCEAIfkEBQcAEAAsAAABABAADwAABV0gJI4kFJToGAilwKLCST6PUcrB8A70844CXenwILRkIoYyBRk4BQlHo3FIOQmvAEGBMpYSop/IgPBCFpCqIuEsIESHgkgoJxwQAjSzwb1DClwwgQhgAVVMIgVyKCEAIfkECQcAEAAsAAAAABAAEAAABWQgJI5kSQ6NYK7Dw6xr8hCw+ELC85hCIAq3Am0U6JUKjkHJNzIsFAqDqShQHRhY6bKqgvgGCZOSFDhAUiWCYQwJSxGHKqGAE/5EqIHBjOgyRQELCBB7EAQHfySDhGYQdDWGQyUhADs=" alt="" />';
			$(function() {
				//热力趋势
				//区域或AP组
				ajaxQ(ajaxUrls.disGroupList, "get", null, function(data) {
					if(data.Code.Code == 200) {
						var disGroupData = data["disgrp_lis"];
						if(disGroupData.length < 1) {
							console.error("无区域或AP组数据。")
						} else {
							//拼下拉列表数据
							var str = "";
							for(var i = 0; i < disGroupData.length; i++) {
								str += "<option value='" + disGroupData[i]._location + "'>" + disGroupData[i].name + "</option>";
							}
							$(".select-dis-group").append(str);
							getGroupAPoptions();
						}
					}
				})
				//AP list
				var getGroupAPoptions = function() {
					var mylocation = $(".select-dis-group").val();
					if(mylocation == "" || mylocation == null) {
						return;
					}
					$(".select-ap-list").html("");
					ajaxQ(ajaxUrls.getGroupAP, "post", {
						_location: mylocation
					}, function(data) {
						if(data.Code.Code == 200) {
							var apGroupData = data["aplis"];
							if(apGroupData.length < 1) {
								console.error("无AP数据。")
							} else {
								//拼下拉列表数据
								var str = "";
								for(var i = 0; i < apGroupData.length; i++) {
									str += "<option value='" + apGroupData[i].ap_mac + "'>" + apGroupData[i].ap_address + "</option>";
								}
								str += "<option value='all'>全部</option>";
								$(".select-ap-list").append(str);
							}
						}
					})
				}
				
				
				var getParams = function() {
					var dis = $(".select-dis-group").val(),
						ap = $(".select-ap-list").val(),
						my_mac_list = [ap],
						my_time_flag = $(".time-flag.on").index() - 1,
						start_time = $("#dateStart").val(),
						end_time = $("#dateEnd").val();

					if(ap == "" || ap == null) {
						alert("请选择AP");
						return;
					}
					if(ap=="all"){
						my_mac_list=[];
						for(var i=0;i<$(".select-ap-list option").length-1;i++){
							my_mac_list.push($(".select-ap-list option:eq("+i+")").val())
						}
					}
					if(start_time == "" || end_time == "") {
						alert("请选择统计时间范围");
						return;
					}
					if(start_time > end_time) {
						alert("统计时间范围有误，请检查");
						return;
					}
					
					start_time = start_time.replace(/(\s+)|(-)|(:00)/g, "");//2017-06-20 08:00转换成2017062008
					end_time = end_time.replace(/(\s+)|(-)|(:00)/g, "");

					var disGroupStaParams = {
						time_flag: parseInt(my_time_flag),
						scope_flag: ap=="all"?1:0,
						_location: ap=="all"?dis:"",
						mac_list: ap=="all"?[]:my_mac_list,
						start_t: parseInt(start_time),
						end_t: parseInt(end_time),
					}
					
					return disGroupStaParams;
				}

				//初始化echarts实例
				var trendChart = echarts.init(document.getElementById('trendChart'));
				//trendChart.showLoading();

				var trendData = {
					xAxisData: [],
					seriesData: []
				}				

				//AP 组（区域）统计数值					
				var getDisGroupSta = function() {
					var disGroupStaParams = getParams();
					trendChart.showLoading();
					$.ajax({
						url: ajaxDomain + ajaxUrls.disGroupSta,
						type: "post",
						data: JSON.stringify(disGroupStaParams),
						contentType: "application/json",
						success: function(data) {
							if(data.Code.Code == 200) {
								var statisData = data["statis_list"];
								if(statisData.length < 1) {
									$("#trendChart").html("暂无数据。");
								} else {
									//拼echart图数据
									trendData.xAxisData = [];
									trendData.seriesData = [];
									for(var i = 0; i < statisData.length; i++) {
										trendData.xAxisData.push(statisData[i].dtime);
										trendData.seriesData.push(statisData[i].sense_tnum)
									}
								}
								getTrendChartOption();
							}
						},
						error: function() {
							console.log("ajax error：");
							console.log(arguments);
							alert("请求数据出错。")
							trendChart.hideLoading();
						}
					});
				}
				
				var pageNum = 1,
					pageSize = 30,
					totalPage = 1;
				var getClientlist = function() {
					var disGroupStaParams = getParams();
					
					var loadOk=false;
					$(".loading-tr td").html(loadingImg+" 数据加载中...");
					$(".loading-tr").show();
					$(".page-box").hide();
						
					disGroupStaParams.page_num=pageNum;
					disGroupStaParams.page_size=pageSize;
					
					$.ajax({
						url: ajaxDomain + ajaxUrls.clientlist,
						type: "post",
						data: JSON.stringify(disGroupStaParams),
						contentType: "application/json",
						success: function(data) {
							if(data.Code.Code == 200) {
								var clientData = data["client_list"];
								if(typeof(clientData)=="undefined" || clientData.length < 1) {
									$(".loading-tr td").html("暂无数据。");
								} else {
									//拼表格数据
									var str="";
									for(var i = 0; i < clientData.length; i++) {
										str+="<tr><td>"+clientData[i].client_mac;
										str+="</td><td>"+clientData[i].name;
										str+="</td><td>"+clientData[i].mobile;
										str+="</td><td>"+clientData[i].stay_hour;
										str+="</td><td>"+clientData[i].rssi;
										str+="</td><td><button>操作</button></td></tr>";
									}
									$(".loading-tr").hide();
									//$(".client-table").append(str);
									$(".client-table tr:not(.th,.loading-tr)").remove();
									$(str).insertAfter(".client-table tr.th");
									
									totalPage = Math.ceil(data.total_num / pageSize);
									$(".page-total").html(totalPage);
									$(".page-now").html(pageNum);
									$(".page-pre,.page-next").removeClass("dis");
									if(pageNum==1){
										$(".page-pre").addClass("dis");
									}
									if(pageNum==totalPage){
										$(".page-next").addClass("dis");
									}
									$(".page-box").show();
								}
								loadOk=true;
							}
						},
						error: function() {
							console.log("ajax error：");
							console.log(arguments);
							alert("请求数据出错。")
							trendChart.hideLoading();
						}
					});
				}

				$(".page-pre").click(function(){
					if(pageNum==1){return}
					pageNum--;
					getClientlist();
				});
				$(".page-next").click(function(){
					if(pageNum==totalPage){return}
					pageNum++;
					getClientlist();
				});
				$(".button-jump").click(function(){
					var pg=parseInt($(".page-num").val());
					if(pg>totalPage || pg<1){return}
					getClientlist();
				});

				$(document).on("change", ".select-dis-group", function() {
					getGroupAPoptions();
				})

				var setDisAndAp = function() {
					var dis = $("#select-dis-group").find("option:selected").text();
					var ap = $("#select-ap-list").find("option:selected").text();
					$(".dis-ap-box").html(dis + " - " + ap);
				}

				$(document).on("click", ".duration span", function() {
					if($(this).hasClass("label") || $(this).hasClass("on")) {
						return;
					}
					$(".duration span").removeClass("on");
					$(this).addClass("on");
					getDisGroupSta();
				})

				$(document).on("click", ".chaxun", function() {
					getDisGroupSta();
					getClientlist();
				})

				function getTrendChartOption() {
					var trendChartOption = {
						title: {
							text: ''
						},
						tooltip: {
							trigger: 'axis',
							axisPointer: {
								type: 'cross',
								label: {
									backgroundColor: '#6a7985'
								}
							}
						},
						//						legend: {
						//							data: trendData.legendData
						//						},
						toolbox: {
							//							feature: {
							//								saveAsImage: {}
							//							}
						},
						dataZoom: [{ // 这个dataZoom组件，默认控制x轴。
							type: 'slider', // 这个 dataZoom 组件是 slider 型 dataZoom 组件
							start: 0, // 左边在 0% 的位置。
							end: 100 // 右边在 100% 的位置。
						}],
						grid: {
							left: '1%',
							right: '1%',
							bottom: '1%',
							containLabel: true
						},
						xAxis: [{
							type: 'category',
							boundaryGap: false,
							data: trendData.xAxisData
						}],
						yAxis: [{
							type: 'value'
						}],
						series: {
							name: "数量",
							type: 'line',
							smooth: true,
							areaStyle: {
								normal: {}
							},
							data: trendData.seriesData
						}
					};
//					console.log(trendChartOption.series)

					//					trendChart.setOption(initTrendChartOption);
					//					setTimeout(function(){
					trendChart.hideLoading();
					trendChart.setOption(trendChartOption);
					//					},200)

				}
				getTrendChartOption();

				$("#dateStart").datetimepicker({
					dateFormat: 'yy-mm-dd',
					stepMinute: 60,
					onClose: function(selectedDate) {
						$("#dateEnd").datetimepicker("option", "minDate", selectedDate);
					}
				});
				$("#dateEnd").datetimepicker({
					dateFormat: 'yy-mm-dd',
					stepMinute: 60,
					onClose: function(selectedDate) {
						$("#dateStart").datetimepicker("option", "maxDate", selectedDate);
					}
				});
				$("#dateStart").datetimepicker("setDate", new Date(new Date().getTime()-1000*60*60*24))
				$("#dateEnd").datetimepicker("setDate", new Date())
			})
		</script>
	</body>

</html>